<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LorekeeperX V17.0 (The Monolith)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet">
    
    <style>
        /* === THEME ENGINE === */
        :root {
            --bg: #0b0c10; --panel: #1f2833; --border: #3b4252;
            --cyan: #66fcf1; --gold: #d4af37; --red: #ff6b6b; --green: #51cf66;
            --text: #e0e6ed; --text-dim: #9aa0a6;
            --font-ui: 'Inter', sans-serif; --font-head: 'Cinzel', serif; --font-body: 'Merriweather', serif;
        }
        body { background: var(--bg); color: var(--text); font-family: var(--font-ui); margin: 0; height: 100vh; overflow: hidden; font-size: 14px; }
        .hidden { display: none !important; }
        
        /* === LOGIN SCREEN === */
        #login-screen { position: fixed; inset: 0; background: radial-gradient(circle, #1f2833 0%, #000 100%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-card { background: rgba(31,40,51,0.8); padding: 40px; border: 1px solid var(--border); border-radius: 12px; width: 300px; text-align: center; backdrop-filter: blur(10px); }
        .login-title { font-family: var(--font-head); font-size: 2rem; margin-bottom: 5px; color: #fff; }
        .login-input { width: 100%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid var(--border); color: #fff; text-align: center; border-radius: 4px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 10px; background: var(--cyan); border: none; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; }
        .login-btn:hover { box-shadow: 0 0 10px var(--cyan); }

        /* === APP SHELL === */
        #app-ui { display: none; flex-direction: column; height: 100vh; max-width: 1600px; margin: 0 auto; border-left: 1px solid var(--border); border-right: 1px solid var(--border); background: #121418; }
        
        /* Header */
        .header { padding: 15px 20px; background: rgba(18,20,24,0.95); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-family: var(--font-head); font-size: 1.4rem; font-weight: bold; letter-spacing: 2px; }
        .brand span { color: var(--cyan); } .brand.admin span { color: var(--gold); }
        .user-badge { border: 1px solid #444; padding: 2px 8px; font-size: 0.8rem; color: #888; border-radius: 4px; margin-left: 10px; }
        
        /* Navigation */
        .nav-bar { display: flex; gap: 5px; background: var(--panel); padding: 4px; border-radius: 8px; }
        .nav-btn { background: transparent; border: none; color: var(--text-dim); padding: 8px 16px; cursor: pointer; font-weight: 600; border-radius: 6px; transition: 0.2s; }
        .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .nav-btn.active-player { background: var(--cyan); color: #000; }
        .nav-btn.active-admin { background: var(--gold); color: #000; }

        /* Viewport */
        .viewport { flex: 1; overflow: hidden; position: relative; }
        .scroll-container { height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }

        /* === COMPONENTS === */
        
        /* Library Table */
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; position: sticky; top: 0; z-index: 10; background: var(--panel); padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
        .table-wrapper { height: 100%; overflow: auto; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 12px; background: #121418; border-bottom: 2px solid var(--border); color: var(--text-dim); position: sticky; top: 0; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
        tr:hover { background: var(--panel); }
        .pill { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; border: 1px solid #555; }
        
        /* Chat */
        .chat-layout { display: flex; flex-direction: column; height: 100%; max-width: 900px; margin: 0 auto; }
        .chat-feed { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 15px; border-radius: 8px; line-height: 1.5; word-wrap: break-word; }
        .msg.user { align-self: flex-end; background: var(--panel); border: 1px solid var(--border); }
        .msg.ai { align-self: flex-start; background: rgba(102, 252, 241, 0.05); border-left: 3px solid var(--cyan); }
        .chat-input-area { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: var(--bg); }
        
        /* Grid (Imagery) */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.2s; }
        .card:hover { transform: translateY(-5px); border-color: var(--cyan); }
        .card-img { height: 150px; width: 100%; object-fit: cover; background: #000; }
        .card-body { padding: 10px; }
        
        /* Profiles */
        .split-view { display: flex; height: 100%; }
        .list-col { width: 250px; border-right: 1px solid var(--border); overflow-y: auto; background: var(--panel); }
        .list-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #333; color: #aaa; }
        .list-item:hover { background: #333; color: #fff; }
        .detail-col { flex: 1; padding: 30px; overflow-y: auto; }
        .dossier-header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--gold); padding-bottom: 10px; margin-bottom: 20px; }
        .dossier-name { font-family: var(--font-head); font-size: 2rem; }
        
        /* Forms */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .span-2 { grid-column: span 2; }
        label { display: block; font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; background: #000; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 4px; box-sizing: border-box; font-family: var(--font-ui); }
        input:focus, textarea:focus { border-color: var(--cyan); outline: none; }
        
        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: var(--panel); width: 900px; max-height: 90vh; overflow-y: auto; padding: 30px; border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        
        /* Buttons */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-green { background: var(--green); color: #000; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-red { background: var(--red); color: #000; }
        .btn-cyan { background: var(--cyan); color: #000; }
        
        /* Utils */
        .tl-row { display: flex; margin-bottom: 10px; padding: 10px; background: var(--panel); border-left: 2px solid var(--gold); cursor: pointer; }
        .tl-date { width: 80px; font-weight: bold; color: var(--gold); flex-shrink: 0; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <div class="login-title">LOREKEEPER<span style="color:var(--cyan)">X</span></div>
            <div style="color:#888; margin-bottom:20px;">V17.0 (The Monolith)</div>
            
            <input id="login-user" class="login-input" placeholder="Identity (Name/Callsign)" autocomplete="off" data-lpignore="true">
            <input id="login-pass" type="password" class="login-input" placeholder="Access Code" autocomplete="off" data-lpignore="true">
            
            <button class="login-btn" onclick="app.auth.login()">CONNECT</button>
        </div>
    </div>

    <div id="app-ui">
        <header class="header">
            <div style="display:flex; align-items:center;">
                <div class="brand" id="brand-logo">LOREKEEPER<span>X</span></div>
                <div class="user-badge" id="user-display">GUEST</div>
            </div>
            
            <div class="nav-bar" id="nav-container">
                </div>

            <div style="display:flex; gap:10px;">
                <select id="persona-select" class="hidden" style="background:#111; border:1px solid #444; width:auto; padding:5px;">
                    <option value="Codex">Codex</option>
                    <option value="Saverath">Saverath</option>
                    <option value="NaVan">Na'Van</option>
                    <option value="Brigit">Capt. Brigit</option>
                    <option value="Leaf">Leaf</option>
                </select>
                <button class="btn" style="background:transparent; color:#888;" onclick="document.getElementById('key-modal').style.display='flex'">⚙️</button>
                <button class="btn" style="background:transparent; color:#888;" onclick="location.reload()">⏻</button>
            </div>
        </header>

        <div class="viewport">
            
            <div id="view-library" class="scroll-container hidden">
                <div class="filter-row">
                    <button class="btn btn-gold" onclick="app.db.load()">REFRESH</button>
                    <button class="btn btn-green" onclick="app.admin.edit({})">+ NEW</button>
                    <input id="lib-search" placeholder="Search..." style="width:200px;" oninput="app.admin.renderLib()">
                    <select id="lib-cat" style="width:150px;" onchange="app.admin.renderLib()">
                        <option value="All">All Categories</option><option>Event</option><option>People</option><option>Location</option><option>History</option><option>Lore</option><option>Journal</option><option>System</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table id="lib-table"><thead><tr><th>Status</th><th>Name</th><th>Category</th><th>Author</th><th>Date</th><th>Modified</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

            <div id="view-timeline" class="scroll-container hidden">
                <div id="timeline-list"></div>
            </div>

            <div id="view-profiles" class="hidden" style="height:100%;">
                <div class="split-view">
                    <div class="list-col" id="profile-list"></div>
                    <div class="detail-col" id="profile-view">Select a tag...</div>
                </div>
            </div>

            <div id="view-import" class="scroll-container hidden" style="text-align:center;">
                <textarea id="csv-paste" style="height:200px; max-width:800px;" placeholder="Paste CSV Data..."></textarea><br>
                <button class="btn btn-green" style="margin-top:10px;" onclick="app.admin.import()">IMPORT DATA</button>
                <button class="btn btn-gold" style="margin-top:10px;" onclick="app.admin.export()">EXPORT CSV</button>
            </div>

            <div id="view-chat" class="hidden" style="height:100%;">
                <div class="chat-layout">
                    <div class="chat-feed" id="chat-feed"><div class="msg ai"><strong>CODEX ONLINE.</strong><br>I am the Steward. How may I assist?</div></div>
                    <div class="chat-input-area">
                        <input id="chat-msg" placeholder="Query Archives..." onkeypress="if(event.key==='Enter') app.player.send()">
                        <button class="btn btn-cyan" onclick="app.player.send()">SEND</button>
                    </div>
                </div>
            </div>

            <div id="view-imagery" class="scroll-container hidden">
                <input style="width:100%; margin-bottom:20px;" placeholder="Search Visuals..." oninput="app.player.renderImg(this.value)">
                <div class="grid" id="img-grid"></div>
            </div>

            <div id="view-atlas" class="hidden" style="height:100%; background:#000; display:flex; align-items:center; justify-content:center;">
                <img src="Tarth 2.1 80.jpg" style="max-width:100%; max-height:100%;" onerror="this.src='https://placehold.co/1200x800/111/444?text=MAP+FILE+NOT+FOUND'">
            </div>

            <div id="view-journal" class="scroll-container hidden">
                <div style="max-width:800px; margin:0 auto; background:var(--panel); padding:30px; border-radius:10px;">
                    <h2 style="color:var(--cyan); margin-top:0;">FIELD JOURNAL</h2>
                    <div class="form-grid">
                        <div class="span-2"><label>Title</label><input id="j-title"></div>
                        <div><label>Date</label><input id="j-date"></div>
                        <div><label>Location</label><input id="j-loc"></div>
                        <div><label>Country</label><input id="j-country"></div>
                        <div><label>Author</label><input id="j-auth" readonly></div>
                        <div class="span-2"><label>Participants (Tags)</label><input id="j-tags"></div>
                    </div>
                    <label>Entry</label><textarea id="j-narr" style="height:200px;"></textarea>
                    <button class="btn btn-cyan" style="width:100%; margin-top:15px;" onclick="app.player.submitJ()">SUBMIT</button>
                </div>
            </div>

        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-box">
            <h2 style="color:var(--gold); margin-top:0;">EDIT RECORD</h2>
            <input type="hidden" id="e-id">
            <div class="form-grid">
                <div class="span-2"><label>Name</label><input id="e-name"></div>
                <div><label>Status</label><select id="e-status"><option>Approved</option><option>Pending</option><option>Draft</option></select></div>
                <div><label>Category</label><select id="e-cat"><option>Event</option><option>People</option><option>Location</option><option>Creature</option><option>History</option><option>Lore</option><option>Journal</option><option>System</option><option>Factions</option></select></div>
                <div><label>Game Date</label><input id="e-date"></div>
                <div><label>Author</label><input id="e-auth"></div>
                <div><label>Game System</label><input id="e-game"></div>
                <div><label>Campaign</label><input id="e-camp"></div>
                <div><label>Perspective</label><input id="e-persp"></div>
                <div><label>Sensory</label><input id="e-sense"></div>
                <div class="span-2"><label>Image URL</label><input id="e-url"></div>
                <div class="span-2"><label>Ref URL</label><input id="e-ref"></div>
                <div class="span-2"><label>Stats Block</label><textarea id="e-stats" style="height:80px; font-family:monospace;"></textarea></div>
                <div class="span-2"><label>Tags</label><input id="e-tags"></div>
                <div class="span-2"><label>Narrative</label><textarea id="e-narr" style="height:150px;"></textarea></div>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <button class="btn btn-red" onclick="app.admin.del()">DELETE</button>
                <div>
                    <button class="btn" style="background:#444; color:#fff; margin-right:10px;" onclick="document.getElementById('edit-modal').style.display='none'">CANCEL</button>
                    <button class="btn btn-gold" onclick="app.admin.save()">SAVE RECORD</button>
                </div>
            </div>
        </div>
    </div>

    <div id="key-modal" class="modal">
        <div class="modal-box" style="width:400px; height:auto; text-align:center;">
            <h3>NEURAL LINK KEY</h3>
            <input id="api-key" type="password" placeholder="Paste Google API Key">
            <button class="btn btn-cyan" style="width:100%; margin-top:15px;" onclick="app.auth.saveKey()">SAVE</button>
            <button class="btn" style="margin-top:10px; background:transparent; color:#888;" onclick="document.getElementById('key-modal').style.display='none'">CLOSE</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, getDocs, orderBy, query, Timestamp, setDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const cfg = { apiKey: "AIzaSyCMWe8wX4FeK1c20OyFsiXLlYmCfkrRprY", authDomain: "gemini--pilot.firebaseapp.com", projectId: "gemini--pilot", storageBucket: "gemini--pilot.firebasestorage.app", messagingSenderId: "257993365424", appId: "1:257993365424:web:aaa9d2c1fba11c20de6875" };
    
    // SINGLE GLOBAL APP OBJECT
    window.app = {
        dbInstance: null,
        data: [],
        user: "Guest",
        role: "guest",
        key: localStorage.getItem('tarth_key') || "",
        md: window.markdownit(),

        // INITIALIZATION
        init: function() {
            const fApp = initializeApp(cfg);
            this.dbInstance = getFirestore(fApp);
            this.db.load();
        },

        // AUTHENTICATION
        auth: {
            login: function() {
                const u = document.getElementById('login-user').value.trim();
                const p = document.getElementById('login-pass').value.trim();
                
                if(u === "Archivist" && p === "DawkKn1ght") {
                    app.role = "admin"; app.user = "The Archivist";
                    app.router.setupAdmin();
                } else if (p === "codex") {
                    if(!u) return alert("Callsign Required");
                    app.role = "player"; app.user = u;
                    app.router.setupPlayer();
                } else {
                    alert("ACCESS DENIED");
                }
            },
            saveKey: function() {
                const k = document.getElementById('api-key').value.trim();
                if(k) { app.key = k; localStorage.setItem('tarth_key', k); alert("Key Saved"); document.getElementById('key-modal').style.display='none'; }
            }
        },

        // ROUTER (NAVIGATION)
        router: {
            setupAdmin: function() {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-ui').style.display = 'flex';
                document.querySelector('.brand span').style.color = 'var(--gold)';
                document.getElementById('user-display').innerText = app.user;
                
                const nav = document.getElementById('nav-container'); nav.innerHTML = "";
                ['Library','Timeline','Profiles','Import'].forEach(t => {
                    nav.innerHTML += `<button class="nav-btn" onclick="app.router.go('${t}')">${t.toUpperCase()}</button>`;
                });
                this.go('Library');
            },
            setupPlayer: function() {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-ui').style.display = 'flex';
                document.querySelector('.brand span').style.color = 'var(--cyan)';
                document.getElementById('user-display').innerText = app.user;
                document.getElementById('persona-select').classList.remove('hidden');
                
                const nav = document.getElementById('nav-container'); nav.innerHTML = "";
                ['Chat','Imagery','Atlas','Journal'].forEach(t => {
                    nav.innerHTML += `<button class="nav-btn" onclick="app.router.go('${t}')">${t.toUpperCase()}</button>`;
                });
                document.getElementById('j-auth').value = app.user;
                this.go('Chat');
            },
            go: function(tab) {
                // Hide all views
                document.querySelectorAll('.scroll-container, #view-profiles, #view-atlas, #view-chat').forEach(e => e.classList.add('hidden'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-player', 'active-admin'));
                
                // Show Target
                const id = 'view-' + tab.toLowerCase();
                const el = document.getElementById(id);
                if(el) el.classList.remove('hidden');
                
                // Highlight Button
                const activeClass = app.role === 'admin' ? 'active-admin' : 'active-player';
                Array.from(document.querySelectorAll('.nav-btn')).find(b => b.innerText === tab.toUpperCase())?.classList.add(activeClass);

                // Trigger Renderers
                if(tab === 'Library') app.admin.renderLib();
                if(tab === 'Timeline') app.admin.renderTime();
                if(tab === 'Profiles') app.admin.renderProf();
                if(tab === 'Imagery') app.player.renderImg();
            }
        },

        // DATABASE OPS
        db: {
            load: async function() {
                const q = query(collection(app.dbInstance, "lore_library"), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);
                app.data = [];
                snap.forEach(d => { 
                    const obj = d.data(); obj.fid = d.id; 
                    app.data.push(obj); 
                });
                if(app.role === 'admin') app.admin.renderLib();
            }
        },

        // ADMIN MODULE
        admin: {
            renderLib: function() {
                const t = document.querySelector('#lib-table tbody'); t.innerHTML = "";
                const term = document.getElementById('lib-search').value.toLowerCase();
                const cat = document.getElementById('lib-cat').value;
                app.data.forEach(d => {
                    if(cat !== 'All' && d.category !== cat) return;
                    if(term && !(d.eventName+d.author).toLowerCase().includes(term)) return;
                    
                    const tr = document.createElement('tr');
                    const mod = d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleDateString() : '-';
                    tr.innerHTML = `<td><span class="pill" style="color:${d.status=='Approved'?'var(--green)':'#aaa'}">${d.status}</span></td><td style="font-weight:bold; color:#fff;">${d.eventName}</td><td>${d.category}</td><td style="color:#888">${d.author||'-'}</td><td>${d.gameDate||'-'}</td><td style="color:#666">${mod}</td>`;
                    tr.onclick = () => this.edit(d.fid);
                    t.appendChild(tr);
                });
            },
            renderTime: function() {
                const c = document.getElementById('timeline-list'); c.innerHTML = "";
                const sorted = [...app.data].sort((a,b) => (parseInt(a.gameDate)||0) - (parseInt(b.gameDate)||0));
                sorted.forEach(d => {
                    if(['Event','History'].includes(d.category)) {
                        c.innerHTML += `<div class="tl-row" onclick="app.admin.edit('${d.fid}')"><div class="tl-date">${d.gameDate}</div><div><div style="font-weight:bold; color:#fff;">${d.eventName}</div><div style="color:#aaa;">${d.narrative}</div></div></div>`;
                    }
                });
            },
            renderProf: function() {
                const l = document.getElementById('profile-list'); l.innerHTML = "";
                const tags = {}; app.data.forEach(d => { if(d.tags) d.tags.split(',').forEach(x => tags[x.trim()]=true); });
                Object.keys(tags).sort().forEach(t => {
                    l.innerHTML += `<div class="list-item" onclick="app.admin.showProf('${t}')">${t}</div>`;
                });
            },
            showProf: function(name) {
                const v = document.getElementById('profile-view');
                const recs = app.data.filter(r => r.tags && r.tags.includes(name));
                const prim = app.data.find(r => r.eventName === name) || {};
                const img = prim.url || `https://placehold.co/600x400/1a1a2e/FFF?text=${name}`;
                const isGhost = !prim.fid;
                v.innerHTML = `
                    <div class="dossier-header"><div class="dossier-name">${name}</div>${isGhost ? `<button class="btn btn-green" onclick="app.admin.edit({eventName:'${name}', category:'People', status:'Draft', tags:'${name}'})">CREATE RECORD</button>` : `<button class="btn" style="background:#333; color:#fff;" onclick="app.admin.edit('${prim.fid}')">EDIT PRIMARY</button>`}</div>
                    <div style="display:flex; gap:20px;">
                        <img src="${img}" style="width:200px; height:300px; object-fit:cover; border:1px solid #444;">
                        <div><h3 style="color:var(--gold)">BIO</h3><p style="color:#ccc;">${prim.narrative||"No primary bio."}</p></div>
                    </div>
                    <h3 style="border-bottom:1px solid #333; margin-top:20px;">TIMELINE</h3>
                    ${recs.map(r=>`<div style="margin-bottom:5px; border-left:2px solid #444; padding-left:10px;"><strong style="color:var(--gold)">${r.gameDate}</strong> ${r.eventName} <span style="color:#666">${r.narrative.substring(0,50)}...</span></div>`).join('')}
                `;
            },
            edit: function(ref) {
                const d = (typeof ref === 'string') ? app.data.find(r => r.fid === ref) : ref;
                // Clear
                ['id','name','date','game','camp','url','ref','persp','sense','stats','tags','narr','auth'].forEach(k => document.getElementById('e-'+k).value = "");
                // Fill
                document.getElementById('e-id').value = d.fid || "";
                document.getElementById('e-name').value = d.eventName || "";
                document.getElementById('e-status').value = d.status || "Approved";
                document.getElementById('e-cat').value = d.category || "Event";
                document.getElementById('e-date').value = d.gameDate || "";
                document.getElementById('e-auth').value = d.author || app.user;
                document.getElementById('e-game').value = d.game || "";
                document.getElementById('e-camp').value = d.campaign || "";
                document.getElementById('e-url').value = d.url || "";
                document.getElementById('e-ref').value = d.reference || "";
                document.getElementById('e-persp').value = d.perspective || "";
                document.getElementById('e-sense').value = d.sensory || "";
                document.getElementById('e-stats').value = d.stats || "";
                document.getElementById('e-tags').value = d.tags || "";
                document.getElementById('e-narr').value = d.narrative || "";
                
                document.getElementById('edit-modal').style.display = 'flex';
            },
            save: async function() {
                const id = document.getElementById('e-id').value;
                const obj = {
                    eventName: document.getElementById('e-name').value, status: document.getElementById('e-status').value,
                    category: document.getElementById('e-cat').value, gameDate: document.getElementById('e-date').value,
                    author: document.getElementById('e-auth').value, game: document.getElementById('e-game').value,
                    campaign: document.getElementById('e-camp').value, url: document.getElementById('e-url').value,
                    reference: document.getElementById('e-ref').value, perspective: document.getElementById('e-persp').value,
                    sensory: document.getElementById('e-sense').value, stats: document.getElementById('e-stats').value,
                    tags: document.getElementById('e-tags').value, narrative: document.getElementById('e-narr').value,
                    timestamp: Timestamp.now()
                };
                if(!id) await setDoc(doc(app.dbInstance, "lore_library", `REC-${Date.now()}`), obj);
                else await setDoc(doc(app.dbInstance, "lore_library", id), obj, {merge:true});
                document.getElementById('edit-modal').style.display = 'none';
                app.db.load();
            },
            del: async function() {
                const id = document.getElementById('e-id').value;
                if(id && confirm("Delete?")) { await deleteDoc(doc(app.dbInstance, "lore_library", id)); document.getElementById('edit-modal').style.display = 'none'; app.db.load(); }
            },
            import: function() {
                const val = document.getElementById('csv-paste').value;
                if(!val) return;
                Papa.parse(val, { header:true, skipEmptyLines:true, complete: async (res) => {
                    let c=0; for(let row of res.data) {
                        await setDoc(doc(app.dbInstance, "lore_library", `IMP-${Date.now()}-${c++}`), {
                            eventName: row['Name']||row['eventName']||"Unknown", gameDate: row['Date']||row['gameDate']||"",
                            category: row['Category']||row['category']||"Event", narrative: row['Narrative']||row['narrative']||"",
                            status: "Approved", author: app.user, timestamp: Timestamp.now()
                        });
                    }
                    alert("Imported "+c); app.db.load();
                }});
            },
            export: function() {
                const h = ["eventName","gameDate","category","status","narrative","tags","game","campaign","perspective","sensory","stats","author"];
                const csv = [h.join(",")];
                app.data.forEach(d => { csv.push(h.map(k => `"${(d[k]||"").toString().replace(/"/g,'""')}"`).join(",")); });
                const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = "lorekeeper_export.csv"; a.click();
            }
        },

        // PLAYER MODULE
        player: {
            renderImg: function(filter="") {
                const g = document.getElementById('img-grid'); g.innerHTML = "";
                app.data.filter(d => d.status === 'Approved').forEach(d => {
                    if(filter && !(d.eventName+d.category).toLowerCase().includes(filter.toLowerCase())) return;
                    const img = d.url && d.url.includes('http') ? d.url : `https://placehold.co/400x600/333/FFF?text=${d.eventName}`;
                    g.innerHTML += `<div class="card"><img src="${img}" class="card-img"><div class="card-body"><strong>${d.eventName}</strong><br><small style="color:var(--cyan)">${d.category}</small></div></div>`;
                });
            },
            send: async function() {
                const inp = document.getElementById('chat-msg');
                const txt = inp.value; if(!txt || !app.key) return;
                this.addMsg(txt, 'user'); inp.value = "";
                const loadId = this.addMsg("Thinking...", 'ai');
                
                const hits = app.data.filter(d => (d.eventName+d.narrative).toLowerCase().includes(txt.toLowerCase())).slice(0, 15);
                const ctx = hits.map(d => `[${d.eventName}]: ${d.narrative}`).join("\n");
                const sys = document.getElementById('persona-select').value;
                
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${app.key}`;
                    const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: `SYSTEM: You are ${sys}.\nCTX:\n${ctx}\nUSER: ${txt}` }] }] }) });
                    const json = await res.json();
                    document.getElementById(loadId).remove();
                    this.addMsg(json.candidates[0].content.parts[0].text, 'ai');
                } catch(e) { document.getElementById(loadId).innerText = "Error connecting."; }
            },
            addMsg: function(t, s) {
                const d = document.createElement('div'); d.className = `msg ${s}`; d.innerHTML = app.md.render(t);
                const f = document.getElementById('chat-feed'); f.appendChild(d); f.scrollTop = f.scrollHeight;
                return d.id = 'msg-'+Date.now();
            },
            submitJ: async function() {
                const d = {
                    eventName: document.getElementById('j-title').value, gameDate: document.getElementById('j-date').value,
                    location: document.getElementById('j-loc').value, country: document.getElementById('j-country').value,
                    author: app.user, tags: document.getElementById('j-tags').value, narrative: document.getElementById('j-narr').value,
                    category: "Journal", status: "Pending", timestamp: Timestamp.now()
                };
                if(!d.eventName) return alert("Title Required");
                await setDoc(doc(app.dbInstance, "lore_library", `JRN-${Date.now()}`), d);
                alert("Submitted."); app.db.load();
            }
        }
    };

    window.onload = function() { app.init(); };
</script>
</body>
</html>