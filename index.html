<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LorekeeperX [AUTO-LINK]</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet">
    
    <style>
        /* === CORE THEME === */
        :root {
            --bg: #0b0c10; --panel: #1f2833; --border: #3b4252;
            --cyan: #4b5554; --gold: #d4af37; --red: #ff6b6b; --green: #51cf66;
            --text: #e0e6ed; --text-dim: #9aa0a6;
            --font-ui: 'Inter', sans-serif; --font-head: 'Cinzel', serif; --font-body: 'Merriweather', serif;
        }
        body { background: var(--bg); color: var(--text); font-family: var(--font-ui); margin: 0; height: 100vh; overflow: hidden; font-size: 14px; }
        .hidden { display: none !important; }
        
        /* === GATEKEEPER (LOGIN) === */
        #gatekeeper { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; }
        .gate-panel { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.3s; position: relative; border-right: 1px solid #222; }
        .gate-panel:hover { background: #111; }
        .gate-panel.codex { border-right: 1px solid var(--cyan); }
        .gate-panel.lore { border-left: 1px solid var(--gold); }
        
        .gate-icon { font-size: 4rem; margin-bottom: 20px; }
        .gate-title { font-family: var(--font-head); font-size: 2rem; letter-spacing: 3px; margin-bottom: 10px; }
        .gate-version { font-size: 0.8rem; color: #666; margin-bottom: 20px; letter-spacing: 1px; font-family: var(--font-ui); border: 1px solid #333; padding: 2px 8px; border-radius: 4px; }
        .gate-input { background: #000; border: 1px solid #444; padding: 12px; color: #fff; text-align: center; width: 250px; margin-bottom: 10px; border-radius: 4px; }
        .gate-btn { padding: 12px 30px; font-weight: bold; border: none; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; width: 250px; transition:0.2s; }
        .gate-btn:hover { transform: scale(1.05); }
        
        /* === APP SHELL === */
        #app-ui { display: none; flex-direction: column; height: 100vh; max-width: 1600px; margin: 0 auto; background: #121418; border-left: 1px solid #333; border-right: 1px solid #333; }
        
        .header { padding: 15px 20px; background: rgba(18,20,24,0.95); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-family: var(--font-head); font-size: 1.5rem; font-weight: bold; min-width: 200px; }
        
        /* NAV BAR FIXED */
        .nav-bar { display: flex; gap: 5px; background: var(--panel); padding: 4px; border-radius: 8px; flex-wrap: wrap; justify-content: center; }
        
        .nav-btn { background: transparent; border: none; color: var(--text-dim); padding: 8px 16px; cursor: pointer; font-weight: 600; border-radius: 6px; transition: 0.2s; }
        .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .nav-btn.active-codex { background: var(--cyan); color: #000; }
        .nav-btn.active-lore { background: var(--gold); color: #000; }

        .viewport { flex: 1; overflow: hidden; position: relative; }
        .scroll-y { height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }

        /* === LIBRARY (ADMIN) === */
        .filter-dock { display: flex; gap: 10px; margin-bottom: 15px; background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid var(--border); flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-label { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 4px; font-weight: bold; }
        .filter-input { background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; }
        
        .table-frame { border: 1px solid var(--border); height: calc(100vh - 250px); overflow: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #121418; text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: var(--text-dim); position: sticky; top: 0; z-index: 10; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); cursor: pointer; color: #ccc; }
        tr:hover td { background: var(--panel); color: #fff; }
        .status-tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; border: 1px solid #555; }

        /* === TIMELINE === */
        .tl-feed { max-width: 1000px; margin: 0 auto; }
        .tl-node { display: flex; margin-bottom: 10px; background: var(--panel); border-left: 3px solid var(--gold); padding: 15px; cursor: pointer; transition: 0.2s; }
        .tl-node:hover { transform: translateX(5px); border-color: var(--cyan); }
        .tl-date { width: 100px; font-weight: bold; color: var(--gold); font-family: monospace; flex-shrink: 0; }
        
        /* === PROFILES === */
        .profile-layout { display: flex; height: 100%; overflow: hidden; }
        .profile-list { width: 250px; background: var(--panel); border-right: 1px solid var(--border); overflow-y: auto; height: 100%; }
        .profile-item { padding: 12px 15px; border-bottom: 1px solid #333; cursor: pointer; color: #aaa; transition: 0.2s; }
        .profile-item:hover { background: #333; color: #fff; padding-left: 20px; }
        .profile-view { flex: 1; padding: 30px; overflow-y: auto; height: 100%; }
        .dossier-grid { display: grid; grid-template-columns: 300px 1fr; gap: 30px; margin-top: 20px; }
        /* 3. Fix Profile Dossier Images */
        .dossier-img { 
            width: auto;          /* Crucial: prevents stretching */
            max-width: 100%;      
            height: auto;         
            max-height: 500px;    
            display: block;       
            margin: 0 auto;       
            object-fit: contain;  
            border: 1px solid var(--border); 
            background: #000; 
        }
        /* 1. Fix Edit Modal Preview (Agatha fits the box) */
        #e-preview {
            height: 300px; 
            width: auto; 
            max-width: 100%; 
            object-fit: contain; 
            display: none; 
            margin: 0 auto; 
            background: #000;
        }                            
        /* === CHAT === */
        .chat-wrap { display: flex; flex-direction: column; height: 100%; max-width: 900px; margin: 0 auto; }
        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 15px; border-radius: 8px; line-height: 1.5; }
        .msg.user { align-self: flex-end; background: var(--panel); border: 1px solid var(--border); }
        .msg.ai { align-self: flex-start; background: rgba(102, 252, 241, 0.05); border-left: 3px solid var(--cyan); }
        .msg button { cursor: pointer; } 
        .msg img {
            width: auto;          /* Crucial: prevents stretching */
            height: auto;
            max-height: 400px;
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            object-fit: contain;
        }
        .chat-tools { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: #121418; }

        /* === FORMS (SHARED) === */
        .form-box { max-width: 900px; margin: 0 auto; background: var(--panel); padding: 30px; border-radius: 10px; border: 1px solid var(--border); }
        .f-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .span2 { grid-column: span 2; }
        .f-label { display: block; font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; }
        .f-input { width: 100%; background: #000; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 4px; box-sizing: border-box; font-family: var(--font-ui); }
        .f-input:focus { outline: none; border-color: var(--cyan); }
        
        /* === MODAL === */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-body { background: #1a1c24; width: 900px; max-height: 95vh; overflow-y: auto; padding: 30px; border: 1px solid var(--border); border-radius: 10px; }

        /* === UTILS === */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:hover { opacity: 0.8; }
        .bg-gold { background: var(--gold); color: #000; }
        .bg-cyan { background: var(--cyan); color: #000; }
        .bg-red { background: var(--red); color: #000; }
        .bg-dark { background: #333; color: #fff; }

       /* === ATLAS (INTERACTIVE MAP) === */
        #atlas-viewport { 
            overflow: hidden; 
            position: relative; 
            width: 100%; 
            height: 100%;       /* Critical */
            min-height: 500px;  /* Safety fallback */
            background: #0b0c10; /* <--- FIXED TYPO HERE (was ackground) */
            cursor: grab; 
        }
        #atlas-viewport:active { cursor: grabbing; }
        #atlas-content { position: absolute; top: 0; left: 0; transform-origin: 0 0; transition: transform 0.1s linear; }
        
        .map-pin { position: absolute; width: 20px; height: 20px; background: var(--gold); border: 2px solid #000; border-radius: 50%; transform: translate(-50%, -50%); cursor: pointer; z-index: 10; transition: 0.2s; box-shadow: 0 0 10px rgba(0,0,0,0.8); }
        .map-pin:hover { transform: translate(-50%, -60%) scale(1.3); background: #fff; z-index: 20; }
        
        .map-label { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; pointer-events: none; opacity: 0; transition: 0.2s; border: 1px solid var(--border); }
        .map-pin:hover .map-label { opacity: 1; bottom: 30px; }

        /* === CANVAS MODE (COMMAND CENTER) === */
        .canvas-layout { display: flex; height: 100%; gap: 20px; padding: 15px; box-sizing: border-box; background: #0b0c10; }
        
        /* Left Column: Chat */
        .canvas-chat-col { width: 450px; display: flex; flex-direction: column; position: relative; flex-shrink: 0; }
        .canvas-feed { flex: 1; overflow-y: auto; padding-bottom: 80px; font-size: 0.95rem; }
        .canvas-feed::-webkit-scrollbar { width: 6px; }
        .canvas-feed::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* Floating Input Pill */
        .canvas-input-dock { position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px 0; background: linear-gradient(to top, #0b0c10 80%, transparent); }
        .canvas-pill { background: #1f2833; border: 1px solid #333; border-radius: 25px; display: flex; align-items: center; padding: 5px 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition:0.2s; }
        .canvas-pill:focus-within { border-color: var(--cyan); box-shadow: 0 4px 20px rgba(75, 255, 255, 0.1); }

        /* Right Column: Work Surface (The Card) */
        .canvas-card { flex: 1; background: #000; border-radius: 16px; border: 1px solid #333; overflow: hidden; position: relative; box-shadow: -5px 0 30px rgba(0,0,0,0.3); display:flex; flex-direction:column; }
        .canvas-toolbar { position: absolute; top: 15px; right: 15px; z-index: 100; display: flex; gap: 10px; }
    </style>
</head>
<body>

    <div id="gatekeeper">
        <div class="gate-panel codex">
            <div class="gate-icon" style="color:var(--cyan)">üíé</div>
            <div class="gate-title" style="color:var(--cyan)">CODEX</div>
            <div class="gate-version">VXX</div>
            <input id="login-player-name" class="gate-input" placeholder="Callsign / Identity" autocomplete="off" data-lpignore="true">
            <input id="login-player-pass" type="password" class="gate-input" placeholder="Access Code (Optional)" autocomplete="off" data-lpignore="true">
            <button class="gate-btn" style="background:var(--cyan); color:#000;" onclick="App.auth.loginPlayer()">ENTER</button>
        </div>
        <div class="gate-panel lore">
            <div class="gate-icon" style="color:var(--gold)">üõ°Ô∏è</div>
            <div class="gate-title" style="color:var(--gold)">LOREKEEPER</div>
            <div class="gate-version">VXX</div>
            <input id="login-admin-pass" type="password" class="gate-input" placeholder="Access Code (Optional)" autocomplete="off" data-lpignore="true">
            <button class="gate-btn" style="background:var(--gold); color:#000;" onclick="App.auth.loginAdmin()">AUTHORIZE</button>
        </div>
    </div>

    <div id="app-ui">
        <header class="header">
            <div style="display:flex; align-items:center;">
                <div class="brand" id="brand-text">LOREKEEPER</div>
                
                <select id="campaign-select" style="margin-left:15px; background:#000; color:var(--gold); border:1px solid #333; padding:5px; border-radius:4px; font-weight:bold; max-width:150px;" onchange="App.setCampaign(this.value)">
                    <option value="Tarth 2.0" selected>Tarth 2.0</option>
                    <option value="System">System</option>
                </select>

                <select id="persona-select" class="hidden" style="margin-left:10px; background:#000; color:var(--cyan); border:1px solid var(--border); padding:5px; border-radius:4px; max-width:150px;">
                    <option value="Codex">Codex (Steward)</option>
                </select>
            </div>
            
            <div class="nav-bar" id="nav-container"></div>

            <div style="display:flex; gap:10px; flex-shrink:0;">
                <button id="switch-btn" class="btn bg-dark hidden" onclick="App.auth.switch()">LOREKEEPER</button>
                <button class="btn" style="background:transparent; color:#888;" title="API Settings" onclick="document.getElementById('key-modal').style.display='flex'">‚öôÔ∏è</button>
                <button class="btn" style="background:transparent; color:#888;" onclick="location.reload()">‚èª</button>
                </div>
        </header>

        <div id="view-dual-mode" class="viewport hidden" style="height:100%;">
            <div class="canvas-layout">
                <div class="canvas-chat-col">
                    <div id="dual-chat-feed" class="canvas-feed"></div>
                    <div class="canvas-input-dock">
                        <div class="canvas-pill">
                            <span style="color:#888; font-size:1.2rem; padding:0 5px; cursor:pointer;">+</span>
                            <button class="btn" style="background:transparent; color:var(--cyan); padding:0 8px; font-size:1.2rem;" title="Generate Visual" onclick="const p = prompt('Describe the visual:'); App.codex.dream(p);">‚ú®</button>
                            <input id="dual-chat-input" style="flex:1; background:transparent; border:none; color:#fff; padding:10px; outline:none; font-family:inherit;" placeholder="Ask Codex...">
                            <button class="btn bg-cyan" style="border-radius:20px; padding:6px 12px; font-size:0.8rem;" onclick="App.codex.sendDual()">‚û§</button>
                        </div>
                    </div>
                </div>

                <div class="canvas-card">
                    <div class="canvas-toolbar">
                        <button class="btn bg-dark" style="border-radius:20px; font-size:0.7rem; opacity:0.8;" onclick="document.getElementById('view-dual-mode').classList.add('hidden');">‚úñ Close</button>
                    </div>
                    <div id="dual-image-viewport" style="position:absolute; inset:0; background:#000; display:flex; align-items:center; justify-content:center; z-index:50;">
                        <img id="dual-image-target" src="" style="width:auto; height:auto; max-width:100%; max-height:100%; object-fit:contain;">
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin-library" class="viewport hidden">
            <div style="padding:20px; height:100%; display:flex; flex-direction:column;">
                <div class="filter-dock">
                    <div class="filter-group"><span class="filter-label">Campaign</span><select id="filt-camp" class="filter-input" onchange="App.admin.renderLib()"><option value="All">All Campaigns</option><option>Tarth 2.0</option><option>System</option></select></div>
                    <div class="filter-group"><span class="filter-label">Category</span><select id="filt-cat" class="filter-input" onchange="App.admin.renderLib()"><option value="All">All</option><option>Event</option><option>People</option><option>Location</option><option>History</option><option>Lore</option><option>Creature</option><option>Journal</option><option>System</option></select></div>
                    <div class="filter-group"><span class="filter-label">Status</span><select id="filt-stat" class="filter-input" onchange="App.admin.renderLib()"><option value="All">All</option><option>Approved</option><option>Pending</option><option>Draft</option><option style="color:red; font-weight:bold;">Recycle Bin</option></select></div>
                    <div class="filter-group" style="flex:1;"><span class="filter-label">Search</span><input id="filt-search" class="filter-input" placeholder="Title, Description..." oninput="App.admin.renderLib()"></div>
                    <div class="filter-group"><span class="filter-label">Actions</span><div style="display:flex; gap:5px;"><button class="btn bg-gold" onclick="App.db.load()">REFRESH</button><button class="btn bg-red" onclick="App.admin.emptyTrash()" title="Empty Recycle Bin" style="margin-right:5px;">üóëÔ∏è</button><button class="btn bg-green" onclick="App.admin.edit({})">NEW</button></div></div>
                </div>
                <div class="table-frame">
                    <table id="lib-table"><thead><tr><th>Status</th><th>Name</th><th>Category</th><th>Campaign</th><th>Date</th><th>Author</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="view-admin-timeline" class="viewport hidden">
            <div class="scroll-y">
                <div id="timeline-list" class="tl-feed"></div>
            </div>
        </div>

        <div id="view-admin-profiles" class="viewport hidden">
            <div class="profile-layout">
                <div class="profile-list" id="profile-list"></div>
                <div class="profile-view" id="profile-detail">
                    <div style="display:flex; align-items:center; justify-content:center; height:100%; color:#666;">
                        Select a Profile Tag from the left.
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin-import" class="viewport hidden">
            <div class="scroll-y" style="text-align:center;">
                <textarea id="import-text" style="width:100%; height:300px; background:#000; color:#fff; font-family:monospace;" placeholder="Paste CSV Data..."></textarea>
                <div style="margin-top:20px;">
                    <button class="btn bg-green" onclick="App.admin.import()">PROCESS IMPORT</button>
                    <button class="btn bg-gold" onclick="App.admin.export()">EXPORT DATABASE</button>
                </div>
            </div>
        </div>

        <div id="view-codex-chat" class="viewport hidden">
            <div class="chat-wrap">
                <div class="chat-area" id="chat-feed"><div class="msg ai"><strong>CODEX ONLINE.</strong><br>I am the Steward. How may I assist?</div></div>
                <div class="chat-tools" style="align-items:flex-end;">
                    <textarea id="chat-input" class="f-input" style="height:60px; resize:none; font-family:inherit;" placeholder="Dictate or type..."></textarea>
                    <button class="btn bg-cyan" style="height:60px; width:100px;" onclick="App.codex.send()">SEND</button>
                </div>
            </div>
        </div>

        <div id="view-codex-contribute" class="viewport hidden">
            <div class="scroll-y">
                <div class="form-box" style="border-color:var(--cyan);">
                    <h2 style="color:var(--cyan); margin-top:0;">CONTRIBUTE RECORD</h2>
                    <p style="color:#888; margin-bottom:20px;">Submissions are flagged as "Pending" for review.</p>
                    <div class="f-grid">
                        <div class="span2"><span class="f-label">Title</span><input id="c-title" class="f-input"></div>
                        <div><span class="f-label">Category</span><select id="c-cat" class="f-input"><option>Journal</option><option>Event</option><option>Person</option><option>Location</option></select></div>
                        <div><span class="f-label">Game Date</span><input id="c-date" class="f-input"></div>
                        <div><span class="f-label">Location</span><input id="c-loc" class="f-input"></div>
                        <div><span class="f-label">Country</span><input id="c-country" class="f-input"></div>
                        <div><span class="f-label">Author</span><input id="c-auth" class="f-input" readonly></div>
                        <div><span class="f-label">Tags</span><input id="c-tags" class="f-input" placeholder="Rikus, Sadira..."></div>
                    </div>
                    <div style="margin-bottom:15px;"><span class="f-label">Stats / Rules</span><textarea id="c-stats" class="f-input" style="height:80px;"></textarea></div>
                    <div style="margin-bottom:15px;"><span class="f-label">Narrative / Entry</span><textarea id="c-narr" class="f-input" style="height:200px;"></textarea></div>
                    <button class="btn bg-cyan" style="width:100%;" onclick="App.codex.submit()">SUBMIT TO ARCHIVES</button>
                </div>
            </div>
        </div>

        <div id="view-codex-imagery" class="viewport hidden">
            <div class="scroll-y">
                <input class="f-input" style="margin-bottom:20px;" placeholder="Search Visuals..." oninput="App.codex.renderImg(this.value)">
                <div id="img-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:20px;"></div>
            </div>
        </div>

        <div id="view-codex-atlas" class="viewport hidden">
            <div id="atlas-viewport">
                <div id="atlas-content">
                    <img id="atlas-img" src="Tarth 2.1 80.jpg" style="display:block; pointer-events:none;" onerror="this.src='https://placehold.co/2000x1500/111/444?text=MAP+IMAGE+NOT+FOUND'">
                    
                    <div id="atlas-pins"></div>
                </div>
            </div>
            
            <div style="position:absolute; bottom:20px; right:20px; display:flex; gap:5px; z-index:100;">
                <button class="btn bg-dark" onclick="App.atlas.reset()">Recenter</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-body">
            <h2 style="color:var(--gold); margin-top:0;">EDIT RECORD</h2>
            <input type="hidden" id="e-id">
            <div class="f-grid">
                <div class="span2" style="text-align:center; background:#000; padding:10px; border:1px solid #333; margin-bottom:10px;">
                    <img id="e-preview" src="" style="width:100%; height:auto; object-fit:contain; display:none; cursor:zoom-in; border:1px solid #333;" onclick="document.getElementById('lightbox-img').src=this.src; document.getElementById('lightbox').style.display='flex';"><div id="e-preview-placeholder" style="color:#444; padding:20px;">NO IMAGE</div>
                </div>
                <div class="span2"><span class="f-label">Name</span><input id="e-name" class="f-input"></div>
                <div><span class="f-label">Status</span><select id="e-status" class="f-input"><option>Approved</option><option>Pending</option><option>Draft</option></select></div>
                <div><span class="f-label">Category</span><select id="e-cat" class="f-input"><option>Event</option><option>People</option><option>Location</option><option>Creature</option><option>History</option><option>Lore</option><option>Journal</option><option>System</option><option>Factions</option></select></div>
                <div><span class="f-label">Game Date</span><input id="e-date" class="f-input"></div>
                <div><span class="f-label">Campaign</span><input id="e-camp" class="f-input"></div>
                <div><span class="f-label">Game System</span><input id="e-game" class="f-input"></div>
                <div><span class="f-label">Author</span><input id="e-auth" class="f-input"></div>
                <div class="span2">
                    <span class="f-label">Image URL / Upload</span>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input id="e-url" class="f-input" placeholder="https://..." oninput="document.getElementById('e-preview').src = this.value; document.getElementById('e-preview').style.display='block';">
                        <input type="file" id="e-file-input" style="display:none" onchange="App.admin.upload()">
                        <button id="btn-upload" class="btn bg-dark" style="font-size:1.2rem;" title="Upload Local File" onclick="document.getElementById('e-file-input').click()">üìÇ</button>
                        <button id="btn-gen" class="btn bg-cyan" style="width:150px; font-size:0.8rem;" onclick="App.admin.magicLens()">‚ú® GENERATE</button>
                    </div>
                </div>
                <div class="span2"><span class="f-label">Stats</span><textarea id="e-stats" class="f-input" style="height:80px; font-family:monospace;"></textarea></div>
                <div class="span2"><span class="f-label">Tags</span><input id="e-tags" class="f-input"></div>
                <div class="span2"><span class="f-label">Narrative</span><textarea id="e-narr" class="f-input" style="height:150px;"></textarea></div>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <button class="btn bg-red" onclick="App.admin.del()">DELETE</button>
                <div>
                    <button class="btn bg-dark" style="margin-right:10px;" onclick="document.getElementById('edit-modal').style.display='none'">CANCEL</button>
                    <button class="btn bg-gold" onclick="App.admin.save()">SAVE RECORD</button>
                </div>
            </div>
        </div>
    </div>

    <div id="key-modal" class="modal">
        <div class="modal-body" style="width:400px; text-align:center;">
            <h2 style="color:var(--cyan); margin-top:0;">NEURAL LINK SETTINGS</h2>
            <input id="api-key-input" type="password" class="f-input" placeholder="Paste Google API Key Here" style="margin-bottom:15px;">
            <button class="btn bg-cyan" style="width:100%;" onclick="App.auth.saveKey()">CONNECT</button>
            <button class="btn bg-dark" style="width:100%; margin-top:10px;" onclick="document.getElementById('key-modal').style.display='none'">CLOSE</button>
        </div>
    </div>
    <div id="linker-modal" class="modal">
    <div class="modal-body" style="width:500px;">
        <h2 style="color:var(--cyan); margin-top:0;">LINK GHOST RECORD</h2>
        <p style="color:#888; font-size:0.9rem;">Select an existing Master Record to merge this ghost tag into.</p>
        
        <input id="link-search" class="f-input" placeholder="Search Records..." oninput="App.admin.renderLinkList()">
        
        <div id="link-list" style="height:300px; overflow-y:auto; margin-top:10px; border:1px solid #333; background:#000;">
            </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
            <button class="btn bg-dark" onclick="document.getElementById('linker-modal').style.display='none'">CANCEL</button>
        </div>
    </div>
    </div>
    <div id="lightbox" class="modal" onclick="this.style.display='none'" style="display:none; align-items:center; justify-content:center; overflow:auto;">
    <div style="height:100%; display:flex; align-items:center;">
        <img id="lightbox-img" src="" style="height:95vh; width:auto; max-width:none; border:2px solid var(--gold); box-shadow:0 0 50px #000;">
    </div>
    </div>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, getDocs, getDoc, orderBy, query, Timestamp, setDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";
    // Configuration
    const cfg = { apiKey: "AIzaSyCMWe8wX4FeK1c20OyFsiXLlYmCfkrRprY", authDomain: "gemini--pilot.firebaseapp.com", projectId: "gemini--pilot", storageBucket: "gemini--pilot.firebasestorage.app", messagingSenderId: "257993365424", appId: "1:257993365424:web:aaa9d2c1fba11c20de6875" };
    
    // UTILS
    const PARSE_DATE = (d) => { if(!d) return -9999; const m = d.toString().match(/-?\d{1,4}/); return m ? parseInt(m[0]) : 0; };
    const GET_IMG = (c,n) => { let bg='333'; if((c||'').match(/People|Faction/)) bg='1a1a2e'; if((c||'').match(/Location/)) bg='0f2027'; return `https://placehold.co/600x400/${bg}/FFF?text=${(n||'IMG').replace(/ /g,'+')}`; };
    // APP CORE
    window.App = {
        version: "V21.57", 
        dbInstance: null, data: [], user: "Guest", role: "guest",
        key: localStorage.getItem('tarth_api_key') || localStorage.getItem('tarth_key') || "", 
        md: window.markdownit({html: true, breaks: true}),

        // === NEW: CAMPAIGN MANAGER ===
        campaign: "Tarth 2.0",
        
        setCampaign: function(name) {
            this.campaign = name;
            
            // 1. Reload Admin View
            if(this.role === 'admin') this.admin.renderLib();
            
            // 2. Reload Map (Visuals)
            this.atlas.loadCampaignMap();
            
            // 3. Reload Personas (Voices)
            this.codex.loadPersonas();
            
            alert(`Context switched to: ${name}`);
        },

        init: function() {
            // 1. Initialize Firebase
            const fApp = initializeApp(cfg);
            this.dbInstance = getFirestore(fApp);
            this.storage = getStorage(fApp);

            // 2. FORCE UPDATE VERSION LABELS
            document.querySelectorAll('.gate-version').forEach(el => el.innerText = App.version);
            
            // 3. Load Data & Assets
            this.db.load().then(() => {
                 this.atlas.loadCampaignMap(); // Load Map Image
                 this.codex.loadPersonas();    // Load Persona Voices
            });
        },

        // 1. AUTHENTICATION
        auth: {
            loginPlayer: function() {
                const u = document.getElementById('login-player-name').value.trim();
                if(!u) return alert("Callsign Required");
                App.role = "player"; App.user = u;
                App.router.initPlayer();
            },
            loginAdmin: function() {
                App.role = "admin"; App.user = "The Archivist";
                App.router.initAdmin();
            },
            switch: function() {
                App.role = "admin"; App.user = "The Archivist"; App.router.initAdmin();
            },
            // FIXED: Improved Settings Modal Opener
            openSettings: function() {
                document.getElementById('key-modal').style.display='flex';
            },
            saveKey: function() {
                const k = document.getElementById('api-key-input').value.trim();
                if(k) { App.key = k; localStorage.setItem('tarth_api_key', k); alert("Key Saved"); document.getElementById('key-modal').style.display='none'; }
            }
        },

        // 2. ROUTING
        router: {
            toggleDual: function() {
                const dual = document.getElementById('view-dual-mode');
                const isHidden = dual.classList.contains('hidden');
                
                document.querySelectorAll('.viewport').forEach(v => v.classList.add('hidden'));
                
                if(isHidden) {
                    dual.classList.remove('hidden');
                    document.getElementById('dual-chat-feed').innerHTML = document.getElementById('chat-feed').innerHTML;
                    App.atlas.initDual();
                } else {
                    dual.classList.add('hidden');
                    this.go('Chat');
                }
            },
            initPlayer: function() {
                document.getElementById('gatekeeper').style.display='none';
                document.getElementById('app-ui').style.display='flex';
                document.getElementById('brand-text').innerHTML = `CODEX <span style="font-size:0.8rem; opacity:0.5;">${App.version}</span>`;
                document.getElementById('persona-select').classList.remove('hidden');
                document.getElementById('switch-btn').classList.remove('hidden');
                
                // FIXED: Removed crash caused by missing 'canvas-btn'

                const nav = document.getElementById('nav-container'); nav.innerHTML = "";
                ['Chat','Contribute','Imagery','Atlas'].forEach(t => nav.innerHTML += `<button class="nav-btn" onclick="App.router.go('${t}')">${t.toUpperCase()}</button>`);
                
                document.getElementById('c-auth').value = App.user;
                this.go('Chat');
            },
            initAdmin: function() {
                document.getElementById('gatekeeper').style.display='none';
                document.getElementById('app-ui').style.display='flex';
                document.getElementById('brand-text').innerHTML = `LOREKEEPER <span style="font-size:0.8rem; opacity:0.5;">${App.version}</span>`;
                document.getElementById('brand-text').style.color = "var(--gold)";
                document.getElementById('persona-select').classList.add('hidden');
                
                // FIXED: Removed crash caused by missing 'canvas-btn'

                const nav = document.getElementById('nav-container'); nav.innerHTML = "";
                ['Library','Timeline','Profiles','Import'].forEach(t => nav.innerHTML += `<button class="nav-btn" onclick="App.router.go('${t}')">${t.toUpperCase()}</button>`);
                
                this.go('Library');
            },
            go: function(tab) {
                document.querySelectorAll('.viewport').forEach(v => v.classList.add('hidden'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-codex','active-lore'));
                
                if(tab==='Atlas') { App.atlas.init(); App.atlas.render(); }

                let target = tab;
                if(tab === 'Contribute') target = 'codex-contribute';
                
                const viewId = `view-${App.role==='admin'?'admin':'codex'}-${target.toLowerCase()}`;
                const el = document.getElementById(viewId);
                
                if(el) el.classList.remove('hidden');
                else {
                    const directEl = document.getElementById(`view-codex-${tab.toLowerCase()}`);
                    if(directEl) directEl.classList.remove('hidden');
                }
                
                const activeClass = App.role==='admin'?'active-lore':'active-codex';
                Array.from(document.querySelectorAll('.nav-btn')).find(b => b.innerText === tab.toUpperCase())?.classList.add(activeClass);

                if(tab==='Library') App.admin.renderLib();
                if(tab==='Timeline') App.admin.renderTime();
                if(tab==='Profiles') App.admin.renderProf();
                if(tab==='Imagery') App.codex.renderImg();
            }
        },

        // 3. DATA
        db: {
            load: async function() {
                // 1. Fetch Main Data
                const q = query(collection(App.dbInstance, "lore_library"), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);
                App.data = [];
                
                snap.forEach(d => { 
                    if (d.id === 'CONFIG_HIDDEN') return; // Don't mix config
                    const o = d.data(); 
                    o.fid = d.id; 
                    App.data.push(o); 
                });

                // 2. Fetch Hidden Tag Config
                try {
                    const cfgSnap = await getDoc(doc(App.dbInstance, "lore_library", "CONFIG_HIDDEN"));
                    if (cfgSnap.exists()) {
                        App.hiddenTags = (cfgSnap.data().list || []).map(t => String(t).toLowerCase());
                    } else {
                        App.hiddenTags = [];
                    }
                } catch(e) { console.log("Config load error:", e); App.hiddenTags = []; }

                // 3. Refresh UI
                if(App.role === 'admin') {
                    const profView = document.getElementById('view-admin-profiles');
                    if(profView && !profView.classList.contains('hidden')) App.admin.renderProf();
                    else App.admin.renderLib();
                }
            }
        },

        // 4. ADMIN FEATURES
        admin: {
            renderLib: function() {
                const t = document.querySelector('#lib-table tbody'); t.innerHTML = "";
                const term = document.getElementById('filt-search').value.toLowerCase();
                const cat = document.getElementById('filt-cat').value;
                const stat = document.getElementById('filt-stat').value;
                const camp = document.getElementById('filt-camp').value;
                const showBin = (stat === 'Recycle Bin');
            
                App.data.forEach(d => {
                    if (showBin && !d.deleted) return;
                    if (!showBin && d.deleted) return;
                
                    if(cat !== 'All' && d.category !== cat) return;
                    if(!showBin && stat !== 'All' && d.status !== stat) return;
                    if(camp !== 'All' && d.campaign !== camp) return;

                    const haystack = (String(d.eventName) + String(d.author) + String(d.narrative) + String(d.tags)).toLowerCase();
                    if(term && !haystack.includes(term)) return;

                    const tr = document.createElement('tr');
                    const statusColor = d.deleted ? 'var(--red)' : (d.status=='Approved'?'var(--green)':'#aaa');
                    const statusText = d.deleted ? 'DELETED' : d.status;
                
                    tr.innerHTML = `<td><span class="status-tag" style="color:${statusColor}">${statusText}</span></td><td style="font-weight:bold; color:#fff;">${d.eventName}</td><td>${d.category}</td><td>${d.campaign||'-'}</td><td>${d.gameDate||'-'}</td><td>${d.author||'System'}</td>`;
                    tr.onclick = () => this.edit(d.fid);
                    t.appendChild(tr);
                });
            },

            hideTag: async function(tagName) {
                if(!confirm(`Hide "${tagName}" from the index?`)) return;
                const safeTag = String(tagName).toLowerCase();
                const currentList = (App.hiddenTags || []).map(t => t.toLowerCase());
                if(currentList.includes(safeTag)) return alert("Already hidden.");
                const newList = [...currentList, safeTag];

                await setDoc(doc(App.dbInstance, "lore_library", "CONFIG_HIDDEN"), { 
                    list: newList, category: "System", eventName: "Hidden Tags Configuration"
                });
                alert("Tag Hidden."); App.db.load(); 
            },

            unhideTag: async function(tagName) {
                const safeTag = String(tagName).toLowerCase();
                const currentList = (App.hiddenTags || []).map(t => t.toLowerCase());
                const newList = currentList.filter(t => t !== safeTag);

                await setDoc(doc(App.dbInstance, "lore_library", "CONFIG_HIDDEN"), { 
                    list: newList, category: "System", eventName: "Hidden Tags Configuration"
                });
                alert("Tag Restored."); App.db.load();
            },

            del: async function() {
                const id = document.getElementById('e-id').value;
                if(!id || !confirm("‚ö† Move this record to the Recycle Bin?")) return;
                const docRef = doc(App.dbInstance, "lore_library", id);
                await setDoc(docRef, { deleted: true }, { merge: true });
                document.getElementById('edit-modal').style.display = 'none';
                App.db.load();
            },
        
            restore: async function() {
                const id = document.getElementById('e-id').value;
                if(!id) return;
                await setDoc(doc(App.dbInstance, "lore_library", id), { deleted: false }, { merge: true });
                alert("Record Restored!");
                document.getElementById('edit-modal').style.display = 'none';
                App.db.load();
            },
        
            edit: function(ref) {
                // 1. RESET GENERATOR BUTTON (Fixes "Dreaming" bug)
                const btnGen = document.getElementById('btn-gen');
                if(btnGen) {
                    btnGen.innerText = "‚ú® GENERATE";
                    btnGen.disabled = false;
                    btnGen.style.opacity = "1";
                }
                const d = (typeof ref === 'string') ? App.data.find(r => r.fid === ref) : ref;
                ['id','name','date','status','cat','game','camp','url','auth','stats','tags','narr'].forEach(k => document.getElementById('e-'+k).value = "");
                document.getElementById('e-id').value = d.fid || "";
                document.getElementById('e-name').value = d.eventName || "";
                document.getElementById('e-status').value = d.status || "Approved";
                document.getElementById('e-cat').value = d.category || "Event";
                document.getElementById('e-date').value = d.gameDate || "";
                document.getElementById('e-auth').value = d.author || App.user;
                document.getElementById('e-game').value = d.game || "";
                document.getElementById('e-camp').value = d.campaign || "";
                document.getElementById('e-url').value = d.url || "";
                document.getElementById('e-stats').value = d.stats || "";
                document.getElementById('e-tags').value = d.tags || "";
                document.getElementById('e-narr').value = d.narrative || "";
            
                // DELETE / RESTORE BUTTON LOGIC
                const btnContainer = document.querySelector('#edit-modal .bg-red').parentElement; 
                if (d.deleted) {
                    document.querySelector('#edit-modal .bg-red').innerText = "‚ôª RESTORE";
                    document.querySelector('#edit-modal .bg-red').onclick = () => App.admin.restore();
                    document.querySelector('#edit-modal .bg-red').className = "btn bg-green"; 
                } else {
                    document.querySelector('#edit-modal .btn.bg-green')?.classList.replace('bg-green', 'bg-red');
                    const delBtn = document.querySelector('#edit-modal .bg-red') || document.querySelector('#edit-modal .bg-green');
                    delBtn.innerText = "DELETE";
                    delBtn.className = "btn bg-red";
                    delBtn.onclick = () => App.admin.del();
                }

                // IMAGE PREVIEW
                const img = document.getElementById('e-preview');
                const txt = document.getElementById('e-preview-placeholder');
                const existingUrl = d.url || "";
                if (existingUrl.length > 10) {
                    img.src = existingUrl; img.style.display = 'inline-block'; txt.style.display = 'none';
                } else {
                    img.style.display = 'none'; txt.style.display = 'block';
                }
                document.getElementById('edit-modal').style.display = 'flex';
            },

            emptyTrash: async function() {
                const trash = App.data.filter(d => d.deleted);
                if(trash.length === 0) return alert("Recycle Bin is empty.");
                if(!confirm(`‚ö† WARNING: PERMANENTLY DELETE ${trash.length} RECORDS?\n\nThis action cannot be undone.`)) return;
                let count = 0;
                for(const d of trash) {
                    await deleteDoc(doc(App.dbInstance, "lore_library", d.fid));
                    count++;
                }
                alert(`Bin Flushed. ${count} records vaporized.`);
                App.db.load();
            },
            // 1. ADD THIS TO App.admin
            upload: async function() {
                const fileInput = document.getElementById('e-file-input');
                const file = fileInput.files[0];
                if (!file) return alert("Select a file first.");

                const btn = document.getElementById('btn-upload');
                const originalText = btn.innerText;
                btn.innerText = "‚è≥";
                btn.disabled = true;

                // 1. Safety Timer: If upload takes > 15s, throw error
                const timer = setTimeout(() => {
                    btn.innerText = "‚ö†Ô∏è TIMEOUT";
                    alert("Upload timed out. This is usually a Firebase Permission issue.\n\nDid you update the Storage Rules in Firebase Console to 'allow read, write: if true;'?");
                    btn.disabled = false;
                    btn.innerText = originalText;
                }, 15000);

                try {
                    const storageRef = ref(App.storage, 'uploads/' + Date.now() + '_' + file.name);
                    
                    // 2. Perform Upload
                    await uploadBytes(storageRef, file);
                    
                    // 3. Get URL
                    const url = await getDownloadURL(storageRef);
                    
                    // Clear timer since we succeeded
                    clearTimeout(timer);

                    document.getElementById('e-url').value = url;
                    const img = document.getElementById('e-preview');
                    img.src = url;
                    img.style.display = 'block'; // Ensure it shows
                    
                    alert("Upload Complete!");
                } catch(e) {
                    clearTimeout(timer); // Clear timer on error
                    console.error(e);
                    alert("Upload Failed: " + e.message);
                }
                
                btn.innerText = originalText;
                btn.disabled = false;
            },

            magicLens: function() {
                const btn = document.getElementById('btn-gen') || event.target;
                const urlInput = document.getElementById('e-url');
                const docId = document.getElementById('e-id').value; // Capture ID immediately

                // 1. CAVEAT: Block if image exists
                if (urlInput.value.trim().length > 10) {
                     return alert("‚õî IMAGE EXISTS.\n\nPlease clear the URL field to generate a new one.");
                }
                
                // 2. REQUIRE SAVED RECORD (For background saving)
                if (!docId) {
                    return alert("Please SAVE this record at least once before generating images.");
                }

                // 3. UI FEEDBACK
                const originalText = "‚ú® GENERATE";
                btn.innerText = "‚è≥ DREAMING...";
                btn.disabled = true;
                btn.style.opacity = "0.7";

                const name = document.getElementById('e-name').value;
                const cat = document.getElementById('e-cat').value;
                const desc = document.getElementById('e-narr').value;
                
                // 4. BUILD URL
                const seed = Math.floor(Math.random() * 999999);
                const prompt = `Fantasy concept art of ${name}, ${cat}. ${desc.substring(0,80)}. Detailed, 8k resolution.`;
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=800&height=600&nologo=true&seed=${seed}`;
                
                // 5. BACKGROUND LOADER
                const loader = new Image();
                
                loader.onload = async function() {
                    // A. AUTO-SAVE to Database (Background)
                    // Uses the 'docId' we captured at the start
                    try {
                        const docRef = doc(App.dbInstance, "lore_library", docId);
                        await setDoc(docRef, { url: url }, { merge: true });
                        console.log("Background Image Saved to " + docId);
                    } catch(e) { console.error("Auto-save failed", e); }

                    // B. UPDATE UI (Only if you are still looking at the same record)
                    const currentId = document.getElementById('e-id').value;
                    if (currentId === docId) {
                        document.getElementById('e-url').value = url;
                        
                        const img = document.getElementById('e-preview');
                        const txt = document.getElementById('e-preview-placeholder');
                        img.src = url;
                        img.style.display = 'inline-block';
                        txt.style.display = 'none';
                        
                        // Success State
                        btn.innerText = "‚úÖ SAVED";
                        setTimeout(() => { 
                            btn.innerText = originalText; 
                            btn.disabled = false; 
                            btn.style.opacity = "1"; 
                        }, 2000);
                    }
                };
                
                loader.onerror = function() {
                    alert("Visual Link Failed. Try again.");
                    btn.innerText = originalText;
                    btn.disabled = false;
                    btn.style.opacity = "1";
                };
                
                loader.src = url;
            },

            linkTarget: null, 
            openLinker: function(ghostName) {
                this.linkTarget = ghostName;
                document.getElementById('linker-modal').style.display = 'flex';
                document.getElementById('link-search').value = "";
                this.renderLinkList();
            },
        
            renderLinkList: function() {
                const term = document.getElementById('link-search').value.toLowerCase();
                const list = document.getElementById('link-list');
                list.innerHTML = "";
                const candidates = App.data.filter(d => 
                    !d.deleted && ['People','Location','Faction','Creature'].includes(d.category) && d.eventName.toLowerCase().includes(term)
                );
                candidates.forEach(c => {
                    const item = document.createElement('div');
                    item.style.padding = "10px"; item.style.borderBottom = "1px solid #333"; item.style.cursor = "pointer"; item.style.color = "#ccc";
                    item.onmouseover = () => item.style.background = "#222"; item.onmouseout = () => item.style.background = "transparent";
                    item.innerHTML = `<strong>${c.eventName}</strong> <span style="font-size:0.7rem; color:#666; border:1px solid #444; padding:1px 4px; border-radius:3px;">${c.category}</span>`;
                    item.onclick = () => this.executeLink(c);
                    list.appendChild(item);
                });
            },
        
            executeLink: async function(targetRecord) {
                if(!confirm(`Link ghost tag "${this.linkTarget}" to Master Record "${targetRecord.eventName}"?`)) return;
                alert(`Linked! In a full database, this would now update all references of '${this.linkTarget}' to point to '${targetRecord.eventName}'.`);
                document.getElementById('linker-modal').style.display = 'none';
                this.renderProf();
            },
            
            renderTime: function() {
                const c = document.getElementById('timeline-list'); c.innerHTML = "";
                const sorted = [...App.data].sort((a,b) => PARSE_DATE(a.gameDate) - PARSE_DATE(b.gameDate));
                sorted.forEach(d => {
                    if(['Event','History'].includes(d.category)) {
                        c.innerHTML += `<div class="tl-node" onclick="App.admin.edit('${d.fid}')"><div class="tl-date">${d.gameDate}</div><div><div style="font-weight:bold; color:#fff;">${d.eventName}</div><div style="color:#aaa;">${d.narrative}</div></div></div>`;
                    }
                });
            },

            renderProf: function(filterType = 'All') {
                const l = document.getElementById('profile-list'); l.innerHTML = "";
                const header = document.createElement('div');
                header.style.padding = "10px 15px"; header.style.borderBottom = "1px solid #444"; header.style.background = "#1a1c24"; header.style.position = "sticky"; header.style.top = "0";
                header.innerHTML = `
                    <div style="font-size:0.7rem; color:#666; margin-bottom:5px;">ENTITY INDEX</div>
                    <select id="prof-filter-select" style="width:100%; background:#000; color:#fff; border:1px solid #444; padding:5px; border-radius:4px; font-size:0.8rem;" onchange="App.admin.renderProf(this.value)">
                        <option value="All" ${filterType==='All'?'selected':''}>All Entities</option>
                        <option value="People" ${filterType==='People'?'selected':''}>People</option>
                        <option value="Location" ${filterType==='Location'?'selected':''}>Locations</option>
                        <option value="Faction" ${filterType==='Faction'?'selected':''}>Factions</option>
                        <option value="Event" ${filterType==='Event'?'selected':''}>Events</option>
                        <option value="Ghost" ${filterType==='Ghost'?'selected':''}>Ghosts (Active)</option>
                        <option value="Hidden" ${filterType==='Hidden'?'selected':''}>--- Hidden Tags ---</option>
                    </select>
                `;
                l.appendChild(header);
                
                const index = new Map(); 
                const hiddenList = App.hiddenTags || [];
                
                App.data.forEach(d => {
                    if(['journal','system'].includes((d.category||'').toLowerCase())) return;
                    index.set(d.eventName.toLowerCase(), { name: d.eventName, type: d.category, isGhost: false });
                });
            
                App.data.forEach(d => {
                    if(!d.tags) return;
                    String(d.tags).split(',').forEach(t => {
                        const clean = t.trim();
                        if(clean.length < 2) return;
                        const key = clean.toLowerCase();
                        const isHidden = hiddenList.map(h => h.toLowerCase()).includes(clean.toLowerCase());
                        if(!index.has(key)) {
                            index.set(key, { name: clean, type: isHidden ? "Hidden" : "Ref", isGhost: true, isHidden: isHidden });
                        }
                    });
                });
            
                const scrollArea = document.createElement('div');
                Array.from(index.values()).sort((a,b) => a.name.localeCompare(b.name)).forEach(e => {
                    if (filterType === 'Hidden') { if (!e.isHidden) return; } 
                    else {
                        if (e.isHidden) return;
                        if (filterType !== 'All' && filterType !== 'Ghost' && !String(e.type).includes(filterType)) return;
                        if (filterType === 'Ghost' && !e.isGhost) return;
                    }
                
                    const div = document.createElement('div');
                    div.className = 'profile-item';
                    div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:${e.isHidden ? '#555' : (e.isGhost ? '#888' : '#fff')}; text-decoration:${e.isHidden?'line-through':''};">${e.name}</span>
                            <span style="font-size:0.65rem; color:#444;">${e.isHidden ? 'HIDDEN' : (e.isGhost ? 'GHOST' : e.type)}</span>
                        </div>`;
                    div.onclick = () => App.admin.showProf(e.name);
                    scrollArea.appendChild(div);
                });
                l.appendChild(scrollArea);
            },

            showProf: function(name) {
                const v = document.getElementById('profile-detail');
                const safeName = String(name).toLowerCase();
                const index = new Map(); 
                App.data.forEach(d => { if(d.eventName && !['journal','system'].includes((d.category||'').toLowerCase())) index.set(String(d.eventName).toLowerCase(), d); });
                
                const master = index.get(safeName);
                const isGhost = !master;
                const type = master ? master.category : "Entity";
                const refs = App.data.filter(r => (r.tags && String(r.tags).toLowerCase().includes(safeName)) || String(r.eventName).toLowerCase() === safeName).sort((a,b) => PARSE_DATE(a.gameDate) - PARSE_DATE(b.gameDate));
                const img = (master && master.url && master.url.includes('http')) ? master.url : GET_IMG(type, name);
                const desc = master ? master.narrative : `<strong>No official record exists.</strong><br>This entity appears in ${refs.length} archive entries.`;

                let html = `
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px;">
                        <div>
                            <h1 style="color:var(--gold); margin:0;">${name}</h1>
                            <div style="display:flex; gap:10px; align-items:center; margin-top:5px;">
                                <span style="color:${isGhost ? 'var(--red)' : 'var(--green)'}; font-size:0.8rem; letter-spacing:1px; border:1px solid #333; padding:2px 6px; border-radius:4px;">${isGhost ? '‚ö† GHOST SIGNAL' : '‚úÖ OFFICIAL RECORD'}</span>
                                <span style="color:#666; font-size:0.8rem;">${type}</span>
                            </div>
                        </div>
                        <div id="prof-btn-area" style="display:flex; gap:10px;"></div>
                    </div>
                    <div class="dossier-grid">
                        <div style="text-align:center;">
                            <img src="${img}" class="dossier-img" 
                                style="border-color:${isGhost ? 'var(--red)' : 'var(--gold)'}; cursor:zoom-in;" 
                                onclick="event.stopPropagation(); document.getElementById('lightbox-img').src=this.src; document.getElementById('lightbox').style.display='flex';">
                            ${!isGhost ? `<div style="margin-top:5px; font-size:0.7rem; color:#666;">ID: ${master.fid}</div>` : ''}
                        </div>
                        <div>
                            <h3 style="color:var(--cyan); margin-top:0;">STATUS</h3>
                            <p style="color:#ccc; white-space:pre-wrap; line-height:1.6; margin-top:0;">${String(desc).trim()}</p>
                            ${(master && master.stats) ? `<div style="background:#222; border:1px solid #444; color:#aaa; padding:15px; margin-top:15px; font-family:monospace; white-space:pre-wrap;">${master.stats}</div>` : ''}
                `;
                if(String(type).toLowerCase().includes('location')) { html += `<div style="background:#0f2027; padding:10px; margin-top:10px; border:1px solid #333;"><strong style="color:var(--gold)">Recorded Events:</strong> ${refs.length}</div>`; }
                html += `</div></div><h3 style="margin-top:30px; border-bottom:1px solid #444; padding-bottom:5px; color:var(--text-dim);">TIMELINE REFERENCES (${refs.length})</h3><div style="margin-top:15px;">`;

                if(refs.length === 0) { html += `<div style="color:#666; font-style:italic;">No recorded events.</div>`; } 
                else {
                    refs.forEach(r => {
                        html += `<div style="margin-bottom:15px; padding-left:15px; border-left:2px solid #444; cursor:pointer;" onclick="App.admin.edit('${r.fid}')">
                            <div style="display:flex; justify-content:space-between;"><span style="color:var(--gold); font-weight:bold;">${r.gameDate || 'Unknown'}</span><span style="font-size:0.7rem; color:#666; border:1px solid #333; padding:2px 5px; border-radius:4px;">${r.category}</span></div>
                            <div style="color:#fff; margin-top:2px;">${r.eventName}</div>
                            <div style="color:#888; font-size:0.9rem; margin-top:5px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${r.narrative}</div>
                        </div>`;
                    });
                }
                html += `</div>`;
                v.innerHTML = html;
                
                // BUTTONS
                const btnArea = document.getElementById('prof-btn-area'); btnArea.innerHTML = ""; 
                const isHidden = (App.hiddenTags || []).map(t => t.toLowerCase()).includes(String(name).toLowerCase());

                if (isHidden) {
                    const btnUnhide = document.createElement('button'); btnUnhide.className = "btn bg-green"; btnUnhide.innerText = "UNHIDE üëÅÔ∏è"; btnUnhide.onclick = () => App.admin.unhideTag(name); btnArea.appendChild(btnUnhide);
                } else if (isGhost) {
                    const btnCreate = document.createElement('button'); btnCreate.className = "btn bg-green"; btnCreate.innerText = "CREATE"; btnCreate.onclick = () => App.admin.edit({eventName: name, category: 'Person', status: 'Approved', tags: name, narrative: `Bio for ${name}...`});
                    const btnLink = document.createElement('button'); btnLink.className = "btn bg-dark"; btnLink.innerText = "LINK üîó"; btnLink.onclick = () => App.admin.openLinker(name);
                    const btnHide = document.createElement('button'); btnHide.className = "btn bg-red"; btnHide.innerText = "HIDE üö´"; btnHide.style.marginRight = "10px"; btnHide.onclick = () => App.admin.hideTag(name);
                    btnArea.appendChild(btnHide); btnArea.appendChild(btnLink); btnArea.appendChild(btnCreate);
                } else {
                    const btnDel = document.createElement('button'); btnDel.className = "btn bg-red"; btnDel.innerHTML = "üóëÔ∏è";
                    btnDel.onclick = async () => { if(confirm("Permanently delete this Master Record?")) { await deleteDoc(doc(App.dbInstance, "lore_library", master.fid)); App.admin.renderProf(); v.innerHTML=""; }};
                    const btnEdit = document.createElement('button'); btnEdit.className = "btn bg-gold"; btnEdit.innerText = "EDIT"; btnEdit.onclick = () => App.admin.edit(master.fid);
                    btnArea.appendChild(btnDel); btnArea.appendChild(btnEdit);
                }
            },            
            
            save: async function() {
                const id = document.getElementById('e-id').value;
                const d = {
                    eventName: document.getElementById('e-name').value, status: document.getElementById('e-status').value,
                    category: document.getElementById('e-cat').value, gameDate: document.getElementById('e-date').value,
                    author: document.getElementById('e-auth').value, game: document.getElementById('e-game').value,
                    campaign: document.getElementById('e-camp').value, url: document.getElementById('e-url').value,
                    stats: document.getElementById('e-stats').value, tags: document.getElementById('e-tags').value,
                    narrative: document.getElementById('e-narr').value, timestamp: Timestamp.now()
                };
                if(!id) await setDoc(doc(App.dbInstance, "lore_library", `REC-${Date.now()}`), d);
                else await setDoc(doc(App.dbInstance, "lore_library", id), d, {merge:true});
                document.getElementById('edit-modal').style.display = 'none';
                App.db.load();
            },
            import: function() {
                const val = document.getElementById('import-text').value;
                if(!val) return;
                Papa.parse(val, { header: true, skipEmptyLines: true, complete: async (res) => {
                    let c=0; for(let row of res.data) {
                        await setDoc(doc(App.dbInstance, "lore_library", `IMP-${Date.now()}-${c++}`), {
                            eventName: row['Name']||"Unknown", gameDate: row['Date']||"", category: row['Category']||"Event",
                            narrative: row['Narrative']||"", status: "Approved", author: App.user, timestamp: Timestamp.now()
                        });
                    }
                    alert("Imported "+c); App.db.load();
                }});
            },
            export: function() {
                const h = ["eventName","gameDate","category","status","narrative","tags","game","campaign","stats","author"];
                const csv = [h.join(",")];
                App.data.forEach(d => { csv.push(h.map(k => `"${(d[k]||"").toString().replace(/"/g,'""')}"`).join(",")); });
                const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = "lorekeeper_export.csv"; a.click();
            }
        },

        // 5. CODEX FEATURES
        codex: {
            loadPersonas: function() {
                const sel = document.getElementById('persona-select');
                if(!sel) return;
                sel.innerHTML = "";
                
                // Add Default
                const optDefault = document.createElement('option');
                optDefault.value = "Codex"; optDefault.innerText = "Codex (Steward)";
                sel.appendChild(optDefault);

                // FIXED: Broader search (Checks Category OR Tags for 'Persona')
                const voices = App.data.filter(d => 
                    (d.category === 'Persona' || d.category === 'System' || (d.tags||'').includes('Persona')) && 
                    (d.campaign === App.campaign || d.campaign === 'All' || !d.campaign)
                );

                voices.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.eventName;
                    opt.innerText = `${v.eventName}`;
                    sel.appendChild(opt);
                });
            },

            dream: function(promptText) {
                if(!promptText) return alert("Describe what you want to see.");
                
                // FIXED: AUTO-OPEN CANVAS
                const canvas = document.getElementById('view-dual-mode');
                canvas.classList.remove('hidden'); 
                document.getElementById('dual-chat-feed').innerHTML = document.getElementById('chat-feed').innerHTML;

                // Ensure Image Mode is Active (Hide Map)
                document.getElementById('dual-atlas-viewport').classList.add('hidden');
                document.getElementById('dual-image-viewport').classList.remove('hidden');

                const imgTarget = document.getElementById('dual-image-target');
                imgTarget.src = "https://placehold.co/800x600/000/FFF?text=DREAMING...";
                
                const seed = Math.floor(Math.random() * 999999);
                const safePrompt = encodeURIComponent(promptText + ", fantasy art style, detailed, 8k");
                const url = `https://image.pollinations.ai/prompt/${safePrompt}?width=800&height=600&nologo=true&seed=${seed}`;
                
                const loader = new Image();
                loader.onload = () => { imgTarget.src = url; };
                loader.src = url;
                
                this.msg(`**VISUALIZING:** ${promptText}`, 'ai');
            },

            msg: function(t, s) {
                const html = App.md.render(t);
                
                // FIXED: AUTO-OPEN CANVAS IF IMAGE DETECTED
                const imgMatch = html.match(/src="([^"]+)"/);
                if(imgMatch && imgMatch[1]) {
                    const url = imgMatch[1];
                    const canvas = document.getElementById('view-dual-mode');
                    
                    // Auto-open Canvas
                    canvas.classList.remove('hidden');
                    
                    // Switch to Image Mode
                    document.getElementById('dual-atlas-viewport').classList.add('hidden');
                    document.getElementById('dual-image-viewport').classList.remove('hidden');
                    
                    document.getElementById('dual-image-target').src = url;
                }

                const d = document.createElement('div'); 
                d.className = `msg ${s}`; 
                d.innerHTML = html;
                const f = document.getElementById('chat-feed'); 
                f.appendChild(d); 
                f.scrollTop = f.scrollHeight;
                
                const dualF = document.getElementById('dual-chat-feed');
                if(dualF) {
                    const clone = d.cloneNode(true);
                    dualF.appendChild(clone);
                    dualF.scrollTop = dualF.scrollHeight;
                }
                
                return d.id = 'm-'+Date.now();
            },

            // Keeps the internal findBestContext
            findBestContext: function(userQuery, data, topN = 5) {
                if (!userQuery || !data || data.length === 0) return [];
                const queryTerms = userQuery.toLowerCase().split(/\s+/).filter(w => w.length > 2);
                return data.map(item => {
                    let score = 0;
                    const title = String(item.eventName || "").toLowerCase();
                    const body = String(item.narrative || "").toLowerCase();
                    const tags = String(item.tags || "").toLowerCase(); 
                    if (title === userQuery.toLowerCase()) score += 100;
                    queryTerms.forEach(term => {
                        if (title.includes(term)) score += 20;
                        if (tags.includes(term)) score += 10;
                        if (body.includes(term)) score += 1;
                    });
                    return { item, score };
                }).filter(x => x.score > 0).sort((a, b) => b.score - a.score).slice(0, topN).map(x => x.item);
            },

            renderImg: function(filter="") {
                const g = document.getElementById('img-grid'); g.innerHTML = "";
                const term = (filter||"").toLowerCase();
                App.data.filter(d => d.status === 'Approved').forEach(d => {
                    if(term && !(d.eventName+d.category).toLowerCase().includes(term)) return;
                    const img = d.url && d.url.includes('http') ? d.url : GET_IMG(d.category, d.eventName);
                    g.innerHTML += `<div style="background:#1f2833; border-radius:8px; overflow:hidden; text-align:center; padding:10px;"><img src="${img}" style="height:200px; width:auto; max-width:100%; object-fit:contain; cursor:zoom-in;" onclick="document.getElementById('lightbox-img').src=this.src; document.getElementById('lightbox').style.display='flex';"><div style="margin-top:10px;"><strong style="font-size:0.9rem;">${d.eventName}</strong><br><small style="color:var(--cyan)">${d.category}</small></div></div>`;
                });
            },
            
            submit: function() {
                const d = {
                    eventName: document.getElementById('c-title').value, category: document.getElementById('c-cat').value,
                    gameDate: document.getElementById('c-date').value, location: document.getElementById('c-loc').value,
                    country: document.getElementById('c-country').value, author: App.user,
                    tags: document.getElementById('c-tags').value, stats: document.getElementById('c-stats').value,
                    narrative: document.getElementById('c-narr').value, status: "Pending", timestamp: Timestamp.now()
                };
                if(!d.eventName) return alert("Title Required");
                setDoc(doc(App.dbInstance, "lore_library", `SUB-${Date.now()}`), d).then(() => {
                    alert("Submitted for Review."); App.router.go('Chat');
                });
            },
            
            sendDual: function() {
                const inp = document.getElementById('dual-chat-input');
                const mainInp = document.getElementById('chat-input');
                if(!inp.value) return;
                
                mainInp.value = inp.value; 
                inp.value = "";
                this.send(); 
                
                setTimeout(() => {
                    document.getElementById('dual-chat-feed').innerHTML = document.getElementById('chat-feed').innerHTML;
                    const f = document.getElementById('dual-chat-feed'); f.scrollTop = f.scrollHeight;
                }, 1500);
            },

            send: async function() {
                const inp = document.getElementById('chat-input');
                const msg = inp.value; 
                
                if(!App.key) return alert("API Key Missing");
                if(!msg) return;

                this.msg(msg, 'user'); inp.value = "";
                const loadId = this.msg("Accessing Archives...", 'ai');
                
                try {
                    const hits = this.findBestContext(msg, App.data);
                    
                    // 1. INJECT URLS INTO CONTEXT
                    const ctx = hits.map(d => `[ENTRY: ${d.eventName}]\nIMAGE_URL: ${d.url || 'None'}\nTAGS: ${d.tags||''}\n${d.narrative}`).join("\n\n");
                    const primer = App.data.map(d => d.eventName).join(", ");
                    
                    // 2. AGGRESSIVE PROMPT (Forces Image Display)
                    const fullPrompt = `
                    SYSTEM: You are the Codex Steward.
                    CRITICAL INSTRUCTION: You MUST display images if available. 
                    If a record has an 'IMAGE_URL', format it EXACTLY like this: ![Title](IMAGE_URL).
                    Do not apologize or say you cannot show images.
                    
                    DATABASE INDEX: ${primer}
                    RELEVANT ARCHIVES:
                    ${ctx}
                    USER QUERY: ${msg}
                    `;
                    
                    const listReq = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${App.key}`);
                    if (!listReq.ok) throw new Error("Could not list models. Check API Key.");
                    const listData = await listReq.json();
                    
                    let targetModel = "gemini-1.5-flash"; 
                    if(listData.models) {
                        const validModels = listData.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));
                        const bestMatch = validModels.find(m => m.name.includes("flash") && !m.name.includes("exp") && !m.name.includes("8b"));
                        if (bestMatch) targetModel = bestMatch.name.replace("models/", "");
                    }

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${targetModel}:generateContent?key=${App.key}`;
                    const res = await fetch(url, { 
                        method: 'POST', headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }], safetySettings: [{ category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }] }) 
                    });
                    
                    if (!res.ok) throw new Error(await res.text());
                    const json = await res.json();
                    if (json.error) throw new Error(json.error.message);
                    
                    document.getElementById(loadId).remove();
                    this.msg(json.candidates[0].content.parts[0].text, 'ai');
                } catch(e) {
                    console.warn("Generation failed:", e);
                    const bubble = document.getElementById(loadId);
                    bubble.innerHTML = `‚ö†Ô∏è <strong>System Error.</strong><br><span style="font-size:0.7rem; color:#ff6b6b; font-family:monospace;">${e.message}</span>`;
                }
            },
        },

        // 6. ATLAS ENGINE (Unified & Smooth)
        atlas: {
            scale: 1, pointX: 0, pointY: 0, panning: false, start: {x:0, y:0},
            
            // FIXED: Added missing function that was causing the crash
            loadCampaignMap: function() {
                const img = document.getElementById('atlas-img');
                if(!img) return;
                
                // Switch map based on campaign
                if(App.campaign === 'System') {
                    img.src = "https://placehold.co/2000x1500/111/444?text=SYSTEM+MODE";
                } else {
                    img.src = "Tarth 2.1 80.jpg"; 
                }
                this.reset();
            },

            mount: function(viewId, contentId) {
                const view = document.getElementById(viewId);
                const content = document.getElementById(contentId);
                if(!view || !content) return;

                this.scale = 1; this.pointX = 0; this.pointY = 0;
                content.style.transform = `translate(0px, 0px) scale(1)`;

                view.onmousedown = (e) => {
                    if(e.target.classList.contains('map-pin')) return;
                    e.preventDefault();
                    this.panning = true;
                    this.start = { x: e.clientX - this.pointX, y: e.clientY - this.pointY };
                    view.style.cursor = "grabbing";
                };

                view.onmouseup = () => { this.panning = false; view.style.cursor = "grab"; };
                view.onmouseleave = () => { this.panning = false; view.style.cursor = "grab"; };

                view.onmousemove = (e) => {
                    if(!this.panning) return;
                    e.preventDefault();
                    this.pointX = e.clientX - this.start.x;
                    this.pointY = e.clientY - this.start.y;
                    content.style.transform = `translate(${this.pointX}px, ${this.pointY}px) scale(${this.scale})`;
                };

                view.onwheel = (e) => {
                    e.preventDefault();
                    const xs = (e.clientX - this.pointX) / this.scale;
                    const ys = (e.clientY - this.pointY) / this.scale;
                    const delta = -Math.sign(e.deltaY);
                    const newScale = Math.min(Math.max(0.2, this.scale + (delta*0.1)), 5);
                    this.pointX = e.clientX - (xs * newScale);
                    this.pointY = e.clientY - (ys * newScale);
                    this.scale = newScale;
                    content.style.transform = `translate(${this.pointX}px, ${this.pointY}px) scale(${this.scale})`;
                };
            },

            init: function() {
                this.mount('atlas-viewport', 'atlas-content');
                this.render('atlas-pins');
            },

            initDual: function() {
                setTimeout(() => {
                    this.mount('dual-atlas-viewport', 'dual-atlas-content');
                    this.render('dual-atlas-pins');
                }, 100);
            },

            showDual: function() {
                document.getElementById('dual-atlas-viewport').classList.remove('hidden');
                document.getElementById('dual-image-viewport').classList.add('hidden');
            },

            resetDual: function() {
                this.scale = 1; this.pointX = 0; this.pointY = 0;
                const el = document.getElementById('dual-atlas-content');
                if(el) el.style.transform = `translate(0px, 0px) scale(1)`;
            },
            reset: function() {
                this.scale = 1; this.pointX = 0; this.pointY = 0;
                const el = document.getElementById('atlas-content');
                if(el) el.style.transform = `translate(0px, 0px) scale(1)`;
            },

            render: function(layerId) {
                const layer = document.getElementById(layerId);
                if(!layer) return;
                layer.innerHTML = "";
                App.data.forEach(d => {
                    if(d.category === 'Location' && d.coords && !d.deleted) {
                        const p = document.createElement('div');
                        p.className = 'map-pin';
                        p.style.left = d.coords.x + "%";
                        p.style.top = d.coords.y + "%";
                        p.innerHTML = `<div class="map-label">${d.eventName}</div>`;
                        layer.appendChild(p);
                    }
                });
            }
        },
    };

    window.onload = function() { App.init(); };
</script>
</body>
</html>